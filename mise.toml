# Manage devtools and tasks with mise-en-place.
# https://mise.jdx.dev/configuration.html

min_version = "2025.12.0"

[tools]
actionlint = "1.7.9"
node = "24.12.0"
pnpm = "10.26.2"

[tasks.build]
depends = ["build-cli", "build-gha", "build-legacy-v1"]
description = "Runs `build-cli`, `build-gha`, and `build-legacy-v1`."
alias = ["b"]

[tasks.build-cli]
# language=sh
run = """
	vite build --ssr src/main-cli.ts --outDir dist/cli/
"""
env = { COMET_PLATFORM = "cli" }
description = "Generates production-grade build artefacts of the v2 command-line entrypoint with Vite."
alias = ["bc"]

[tasks.build-gha]
# language=sh
run = """
	vite build --ssr src/main-gha.ts --outDir dist/gha/
"""
env = { COMET_PLATFORM = "gha" }
description = "Generates production-grade build artefacts of the v2 GitHub Actions entrypoint with Vite."
alias = ["bg"]

[tasks.build-legacy-v1]
# language=sh
run = """
	vite build --ssr src/legacy-v1-main.ts --outDir dist/
"""
description = "Generates production-grade build artefacts of the legacy v1 GitHub Actions entrypoint with Vite."

[tasks.check]
depends = ["check-actions", "check-format", "check-types"] # Skip the time-consuming `check-renovate` task.
description = "Runs `check-actions`, `check-format`, and `check-types`."
alias = ["c"]

[tasks.check-actions]
# language=sh
run = """
	actionlint
"""
description = "Verifies the syntax of the GitHub Actions workflows with actionlint."
alias = ["ca"]

[tasks.check-format]
# language=sh
run = """
	biome check --error-on-warnings
"""
description = "Verifies the code style of the source code with Biome."
alias = ["cf"]

[tasks.check-renovate]
# language=sh
run = """
	pnpm dlx --package renovate renovate-config-validator
"""
description = "Verifies the syntax of the Renovate configuration."
alias = ["cr"]

[tasks.check-types]
# language=sh
run = """
	tsgo
"""
description = "Verifies the type safety of the source code with TypeScript."
alias = ["ct"]

[tasks.format]
# language=sh
run = """
	biome check --skip-parse-errors --write
"""
description = "Reformats the source code with Biome."
alias = ["f"]

[tasks.install]
# language=sh
run = """
	mise install
"""
description = "Installs all third-party dependencies with mise-en-place and pnpm and enables the Git hooks with Lefthook."
alias = ["i"]

[tasks.post-checkout]
depends = ["install"]
description = "Runs `install` after checking out a branch or a commit."
hide = true

[tasks.post-rewrite]
depends = ["install"]
description = "Runs `install` after rebasing onto another branch or commit."
hide = true

[tasks.pre-commit]
depends = ["format"]
description = "Runs `format` before committing changes."
hide = true

[tasks.pre-push]
depends = ["check", "test"]
description = "Runs `check` and `test` before allowing commits to be pushed."
hide = true

[tasks.test]
# language=sh
run = """
	vitest run
"""
description = "Runs the entire unit test suite once with Vitest."
alias = ["t"]

[tasks.vitest]
# language=sh
run = """
	vitest watch \
		--ui \
		--api.port "$LOCALHOST_VITEST_PORT" \
		--open "$LOCALHOST_VITEST_OPENS_AUTOMATICALLY"
"""
description = "Starts the Vitest UI test explorer for continuous unit testing."
alias = ["v"]

[tasks.yolo]
# language=sh
run = """
	lefthook uninstall
"""
description = "Disables the Git hooks with Lefthook."

[hooks]
# language=sh
postinstall = """
	pnpm install --frozen-lockfile --ignore-scripts

	if [ -z "$LEFTHOOK" ] || [ "$LEFTHOOK" = '1' ] || [ "$LEFTHOOK" = 'true' ]; then
		lefthook install
	fi
"""

[env]
# Load environment variables from the `.env` and `.env.local` files.
# https://mise.jdx.dev/environments/#env-file
_.file = [".env", ".env.local"]

# Make CLI programs in `node_modules` available directly in the command line.
# https://mise.jdx.dev/mise-cookbook/nodejs.html#add-node-modules-binaries-to-the-path
_.path = ["node_modules/.bin"]

# Align the behaviour of the local environment with the CI environment in GitHub Actions by default.
CI = 1

# Grab the current Comet version from the `version` field in `package.json`.
COMET_VERSION = { value = "{{ exec(command=\"jq --raw-output .version package.json\") }}" }

[settings]
experimental = true # Enable the `[hooks]` section.

# Suppress printing the `run` input command in the console when running a mise task.
quiet = true
